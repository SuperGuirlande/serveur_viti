{% extends "main/base.html" %}
{% load custom_filters %}

{% block title %}
Sélection des plantes - Base de données interactive
{% endblock %}

{% block extra_head %}
{{ block.super }}
{{ remede.sort_params|json_script:"remede-sort-params" }}
<style>
    .activity-section {
        margin-bottom: 1rem;
    }

    .activity-section h2 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
    }

    .plant-table {
        width: 100%;
        border-collapse: collapse;
        position: relative;
        font-size: 0.875rem;
    }

    .plant-table th {
        background-color: #3b7e4610;
        color: #3b7e46;
        text-align: left;
        padding: 0.5rem 0.75rem;
        font-weight: 600;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .plant-table tr {
        border-bottom: 1px solid #3b7e4620;
        transition: all 0.2s ease-in-out;
    }

    .plant-table tr.selected-elsewhere {
        background-color: #f3f4f6;
    }

    .plant-table tr.selected-elsewhere label {
        cursor: pointer;
    }

    .plant-table tr.selected-elsewhere .metabolites-tooltip {
        opacity: 1 !important;
    }

    .plant-table td {
        padding: 0.5rem 0.75rem;
    }

    .plant-checkbox {
        width: 1rem;
        height: 1rem;
        color: #3b7e46;
        border-color: #3b7e46;
        border-radius: 0.25rem;
    }

    .concentration-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .concentration-high {
        background-color: #3b7e4610;
        color: #3b7e46;
    }

    .concentration-medium {
        background-color: #3b7e4610;
        color: #3b7e46;
    }

    .concentration-low {
        background-color: #3b7e4610;
        color: #3b7e46;
    }

    .text-blue-600 {
        color: #2563eb;
    }

    .text-green-600 {
        color: #16a34a;
    }

    .pill-blue {
        background-color: #2563eb20;
        color: #2563eb;
        border: 1px solid #2563eb40;
    }
    
    .pill-green {
        background-color: #16a34a20;
        color: #16a34a;
        border: 1px solid #16a34a40;
    }

    .pill-purple {
        background-color: #8b5cf620;
        color: #8b5cf6;
        border: 1px solid #8b5cf640;
    }

    .pill-pink {
        background-color: #ec489920;
        color: #ec4899;
        border: 1px solid #ec489940;
    }
    
    
    
    .legend-container {
        margin-top: 1rem;
        padding: 0.75rem;
        background-color: #f9fafb;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
    }
    
    .legend-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: #374151;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
        font-size: 0.75rem;
        color: #4b5563;
    }
    
    .legend-color {
        width: 1rem;
        height: 1rem;
        border-radius: 0.25rem;
        margin-right: 0.5rem;
    }

    .plant-row {
        position: relative;
    }

    .plant-row td {
        position: static;
    }

    .metabolites-tooltip {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        width: 600px;
        z-index: 9999;
        transition: opacity 0.2s ease-in-out;
        display: flex;
        gap: 1rem;
        right: 0;
        top: 0;
        margin-left: 20px;
    }

    .metabolites-section {
        flex: 1;
        margin-bottom: 0;
    }

    .metabolites-section h4 {
        color: #3b7e46;
        font-weight: 600;
        margin-bottom: 0.25rem;
        padding-bottom: 0.15rem;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .metabolites-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
        padding-right: 0.5rem;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.15rem;
    }

    .metabolites-list::-webkit-scrollbar {
        width: 4px;
    }

    .metabolites-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
    }

    .metabolites-list::-webkit-scrollbar-thumb {
        background: #3b7e46;
        border-radius: 2px;
    }

    .metabolite-item {
        padding: 0.15rem 0.35rem;
        font-size: 0.7rem;
        color: #374151;
        border-radius: 0.25rem;
        transition: background-color 0.2s;
        background-color: #f3f4f6;
        line-height: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .metabolite-item:hover {
        background-color: #3b7e4610;
        color: #3b7e46;
        white-space: normal;
        position: relative;
        z-index: 1;
    }

    .plant-row:hover .metabolites-tooltip {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }

    .overflow-x-auto {
        position: relative;
        overflow: visible !important;
        width: 100%;
    }

    .tooltip-cell {
        position: relative;
        padding: 0 !important;
        width: 0;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Parse les données JSON de manière sécurisée
        let allPlantsData = {};
        let activities = [];
        
        try {
            allPlantsData = JSON.parse('{{ all_plants_data_json|escapejs }}');
        } catch (e) {
            console.error('Erreur lors du parsing des données des plantes:', e);
        }
        
        try {
            activities = JSON.parse('{{ activities_json|escapejs }}');
        } catch (e) {
            console.error('Erreur lors du parsing des activités:', e);
        }

        const checkboxes = document.querySelectorAll('.plant-checkbox');
        const plantRows = {};
        const recapSection = document.getElementById('selected-plants-recap');

        // Fonction pour formater la concentration
        function formatConcentration(concentration) {
            if (concentration === null || concentration === undefined) {
                return 'Non spécifiée';
            }
            return parseFloat(concentration).toFixed(2);
        }

        // Fonction pour mettre à jour le récapitulatif
        function updateRecap() {
            const selectedPlants = new Set();
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedPlants.add(checkbox.value);
                }
            });

            let recapHTML = '';
            
            if (selectedPlants.size === 0) {
                recapHTML = '<p class="text-gray-500 italic">Aucune plante sélectionnée</p>';
            } else {
                // Pour chaque activité
                activities.forEach(activity => {
                    const activityPlants = [];
                    let totalConcentration = 0;
                    const commonMetabolites = new Map();
                    const complementaryMetabolites = new Map();

                    // Récupérer les plantes sélectionnées pour cette activité
                    selectedPlants.forEach(plantId => {
                        const plantData = allPlantsData[plantId];
                        console.log('Plant Data for', plantId, ':', plantData);
                        if (plantData && plantData.activities[activity]) {
                            activityPlants.push(plantData);
                            totalConcentration += parseFloat(plantData.activities[activity].concentration || 0);

                            // Compter les métabolites communs
                            const activityData = plantData.activities[activity];
                            console.log('Activity Data for', activity, ':', activityData);
                            if (activityData.common_metabolites_names && activityData.common_metabolites_names.length > 0) {
                                activityData.common_metabolites_names.forEach(metabolite => {
                                    commonMetabolites.set(metabolite, (commonMetabolites.get(metabolite) || 0) + 1);
                                });
                            }

                            // Compter les métabolites complémentaires
                            if (activityData.complementary_metabolites_names && activityData.complementary_metabolites_names.length > 0) {
                                activityData.complementary_metabolites_names.forEach(metabolite => {
                                    complementaryMetabolites.set(metabolite, (complementaryMetabolites.get(metabolite) || 0) + 1);
                                });
                            }
                        }
                    });

                    if (activityPlants.length > 0) {
                        recapHTML += `
                            <div class="mb-8">
                                <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-flask"></i>
                                    ${activity}
                                </h3>
                                
                                <!-- Plantes sélectionnées -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Plantes sélectionnées :</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${activityPlants.map(plant => `
                                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                                                ${plant.name}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Concentration totale -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Concentration totale :</h4>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                                        ${totalConcentration.toFixed(2)}
                                    </span>
                                </div>

                                <!-- Métabolites communs -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Métabolites communs avec la plante cible :</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${Array.from(commonMetabolites.entries()).map(([metabolite, count]) => `
                                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                                                ${metabolite} (${count})
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Métabolites complémentaires -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Métabolites complémentaires :</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${Array.from(complementaryMetabolites.entries()).map(([metabolite, count]) => `
                                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                                                ${metabolite} (${count})
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            recapSection.innerHTML = recapHTML;
        }

        // Initialiser le mapping des lignes
        checkboxes.forEach(checkbox => {
            const plantId = checkbox.value;
            if (!plantRows[plantId]) {
                plantRows[plantId] = [];
            }
            plantRows[plantId].push(checkbox.closest('tr'));
        });

        // Gérer les plantes déjà sélectionnées au chargement
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const plantId = checkbox.value;
                // Marquer les autres occurrences de la même plante comme sélectionnées ailleurs
                plantRows[plantId].forEach(row => {
                    if (row.querySelector('.plant-checkbox') !== checkbox) {
                        row.classList.add('selected-elsewhere');
                        // Ne pas désactiver la case à cocher pour permettre de la décocher
                    }
                });
            }
        });

        // Ajouter les écouteurs d'événements pour les changements
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const plantId = this.value;
                const isChecked = this.checked;
                
                // Mettre à jour toutes les cases à cocher pour cette plante
                plantRows[plantId].forEach(row => {
                    const otherCheckbox = row.querySelector('.plant-checkbox');
                    // Synchroniser l'état de toutes les cases à cocher pour cette plante
                    if (otherCheckbox !== this) {
                        otherCheckbox.checked = isChecked;
                    }
                    
                    // Mettre à jour la classe CSS
                    if (isChecked) {
                        row.classList.add('selected-elsewhere');
                    } else {
                        row.classList.remove('selected-elsewhere');
                    }
                });
                
                // Mettre à jour le récapitulatif
                updateRecap();
            });
        });

        // Initialiser le récapitulatif
        updateRecap();

        // Gestion des tooltips
        document.querySelectorAll('.plant-row').forEach(row => {
            const tooltip = row.querySelector('.metabolites-tooltip');
            
            row.addEventListener('mouseenter', (e) => {
                if (tooltip) {
                    const rect = row.getBoundingClientRect();
                    
                    // Ajuster la position verticale si la tooltip dépasse le bas de l'écran
                    const tooltipHeight = tooltip.offsetHeight;
                    const windowHeight = window.innerHeight;
                    if (rect.top + tooltipHeight > windowHeight) {
                        tooltip.style.top = `${windowHeight - tooltipHeight - 20}px`;
                    }
                }
            });
        });

        // Fonction pour charger les métabolites
        async function loadMetabolites(searchTerm, selectId) {
            try {
                const response = await fetch(`{% url 'search_metabolites' %}?q=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Sélectionnez un métabolite...</option>';
                
                data.forEach(metabolite => {
                    const option = document.createElement('option');
                    option.value = metabolite.id;
                    option.textContent = metabolite.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des métabolites:', error);
            }
        }

        // Gérer la recherche pour chaque select
        for (let i = 1; i <= 3; i++) {
            const searchInput = document.getElementById(`search${i}`);
            const select = document.getElementById(`metabolite${i}`);
            let timeoutId;

            // Fonction pour mettre à jour le select
            function updateSelect(value) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    loadMetabolites(value, `metabolite${i}`);
                }, 300);
            }

            // Écouter les changements de valeur (saisie manuelle)
            searchInput.addEventListener('input', function() {
                updateSelect(this.value);
            });

            // Écouter les changements programmatiques
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                        updateSelect(searchInput.value);
                    }
                });
            });

            observer.observe(searchInput, {
                attributes: true,
                attributeFilter: ['value']
            });

            // Charger les métabolites initiaux et pré-sélectionner la valeur
            const selectedValue = select.value;
            if (selectedValue) {
                // Charger tous les métabolites
                loadMetabolites('', `metabolite${i}`).then(() => {
                    // Sélectionner la valeur
                    select.value = selectedValue;
                    // Trouver le nom du métabolite sélectionné
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption) {
                        // Pré-remplir le champ de recherche
                        searchInput.value = selectedOption.text;
                        // Mettre à jour le select avec le nom
                        updateSelect(selectedOption.text);
                    }
                });
            }
        }

        // Pré-remplir les champs avec les valeurs de l'URL
        const urlParams = new URLSearchParams(window.location.search);
        for (let i = 1; i <= 3; i++) {
            const metaboliteId = urlParams.get(`metabolite${i}`);
            if (metaboliteId) {
                const select = document.getElementById(`metabolite${i}`);
                const searchInput = document.getElementById(`search${i}`);
                
                // D'abord, charger le métabolite spécifique
                fetch(`{% url 'search_metabolites' %}?id=${metaboliteId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const metabolite = data[0];
                            // Mettre le nom dans le champ de recherche
                            searchInput.value = metabolite.name;
                            // Mettre à jour le select avec le nom
                            loadMetabolites(metabolite.name, `metabolite${i}`).then(() => {
                                // Une fois les métabolites chargés, sélectionner le bon
                                select.value = metaboliteId;
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement du métabolite:', error);
                    });
            }
        }

        // Pré-remplir les champs avec les valeurs des sort_params du remède
        const remedeSortParams = JSON.parse(document.getElementById('remede-sort-params').textContent);
        for (let i = 1; i <= 3; i++) {
            const metaboliteId = remedeSortParams[`metabolite${i}`];
            if (metaboliteId && !urlParams.get(`metabolite${i}`)) {  // Ne pas écraser si déjà dans l'URL
                const select = document.getElementById(`metabolite${i}`);
                const searchInput = document.getElementById(`search${i}`);
                
                // D'abord, charger le métabolite spécifique
                fetch(`{% url 'search_metabolites' %}?id=${metaboliteId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const metabolite = data[0];
                            // Mettre le nom dans le champ de recherche
                            searchInput.value = metabolite.name;
                            // Mettre à jour le select avec le nom
                            loadMetabolites(metabolite.name, `metabolite${i}`).then(() => {
                                // Une fois les métabolites chargés, sélectionner le bon
                                select.value = metaboliteId;
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement du métabolite:', error);
                    });
            }
        }
    } catch (error) {
        console.error('Erreur lors de l\'initialisation:', error);
    }
});

// Fonction pour mettre à jour les champs cachés du formulaire avec les paramètres de tri actuels
function updateHiddenSortFields() {
    const urlParams = new URLSearchParams(window.location.search);
    const form = document.getElementById('plants-form');
    
    // Supprimer les anciens champs cachés
    const oldHiddenFields = form.querySelectorAll('input[name^="sort"], input[name^="direction"]');
    oldHiddenFields.forEach(field => field.remove());
    
    // Ajouter les nouveaux champs cachés
    for (let i = 0; i < 4; i++) {
        const field = urlParams.get(`sort${i}`);
        const direction = urlParams.get(`direction${i}`);
        
        if (field && direction) {
            const fieldInput = document.createElement('input');
            fieldInput.type = 'hidden';
            fieldInput.name = `sort${i}`;
            fieldInput.value = field;
            form.appendChild(fieldInput);
            
            const directionInput = document.createElement('input');
            directionInput.type = 'hidden';
            directionInput.name = `direction${i}`;
            directionInput.value = direction;
            form.appendChild(directionInput);
        }
    }
    
    // Synchroniser l'état de la case à cocher d'exclusion des métabolites ubiquitaires
    const excludeUbiquitousSort = document.getElementById('exclude_ubiquitous_sort');
    const excludeUbiquitous = document.getElementById('exclude_ubiquitous');
    
    if (excludeUbiquitousSort && excludeUbiquitous) {
        excludeUbiquitous.checked = excludeUbiquitousSort.checked;
    }
}

// Mettre à jour les champs cachés au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    updateHiddenSortFields();
    
    // Mettre à jour les champs cachés lorsque l'URL change
    window.addEventListener('popstate', updateHiddenSortFields);
    
    // Synchroniser les deux cases à cocher d'exclusion des métabolites ubiquitaires
    const excludeUbiquitousSort = document.getElementById('exclude_ubiquitous_sort');
    const excludeUbiquitous = document.getElementById('exclude_ubiquitous');
    
    if (excludeUbiquitousSort && excludeUbiquitous) {
        excludeUbiquitousSort.addEventListener('change', function() {
            excludeUbiquitous.checked = this.checked;
        });
        
        excludeUbiquitous.addEventListener('change', function() {
            excludeUbiquitousSort.checked = this.checked;
        });
    }

    // Mettre à jour les champs cachés des métabolites avant la soumission du formulaire
    const plantsForm = document.getElementById('plants-form');
    if (plantsForm) {
        plantsForm.addEventListener('submit', function() {
            for (let i = 1; i <= 3; i++) {
                const select = document.getElementById(`metabolite${i}`);
                const hiddenInput = document.getElementById(`hidden_metabolite${i}`);
                if (select && hiddenInput) {
                    hiddenInput.value = select.value;
                }
            }
        });
    }
});
</script>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="relative min-h-[40vh] bg-gradient-to-b from-green-900 to-green-700 flex flex-col items-center poppins">
    <!-- Overlay pattern -->
    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zNiAzNGM0LjQxOCAwIDgtMy41ODIgOC04cy0zLjU4Mi04LTgtOC04IDMuNTgyLTggOCAzLjU4MiA4IDggOHoiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLW9wYWNpdHk9Ii4xIi8+PC9nPjwvc3ZnPg==')] opacity-10"></div>

    <!-- Contenu du hero -->
    <div class="relative z-10 container mx-auto px-4 h-full flex flex-col justify-center items-center py-12 my-auto w-fit">
        <a href="{% url 'create_remede' %}" class="text-white hover:text-green-500 text-xs flex items-center gap-2 text-left self-start group">
            <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-all duration-300"></i>
            <p class="group-hover:translate-x-1 transition-all duration-300">Retour</p>
        </a>
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 flex items-center gap-2 mx-auto">
            <span><i class="fa-solid fa-leaf"></i></span>
            <span>Sélection des plantes</span>
        </h1>
        <p class="text-lg text-gray-100 max-w-2xl text-center">
            Sélectionnez les plantes pour votre remède "{{ remede.name }}"
        </p>
    </div>

    <!-- Vague décorative -->
    <div class="absolute -bottom-1 left-0 right-0">
        <svg class="w-full scale-110 h-24 fill-white" viewBox="0 0 1440 74" xmlns="http://www.w3.org/2000/svg">
            <path d="M0,32L60,37.3C120,43,240,53,360,53.3C480,53,600,43,720,42.7C840,43,960,53,1080,53.3C1200,53,1320,43,1380,37.3L1440,32L1440,74L1380,74C1320,74,1200,74,1080,74C960,74,840,74,720,74C600,74,480,74,360,74C240,74,120,74,60,74L0,74Z"></path>
        </svg>
    </div>
</section>

<!-- Résumé du remède -->
<section class="w-full px-4 py-12">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-2xl font-bold text-green-700 flex gap-5">
                <span>
                    <i class="fa-solid fa-book-open"></i>
                </span>
                <span>
                    Résumé du remède
                </span>
            </h2>
            <!-- Nom du remède -->
            <div class="flex gap-2 items-center text-lg font-bold text-green-700 mt-7">
                <i class="fa-solid fa-pen-to-square"></i> 
                <h3 class=" flex gap-2">Nom du remède</h3>
            </div>
            <p class="text-gray-600 mt-2">{{ remede.name }}</p>
            <!-- Description -->
            {% if remede.description %}
            <div class="flex gap-2 items-center text-lg font-bold text-green-700 mt-5">
                <i class="fa-solid fa-pen-to-square"></i> 
                <h3 class=" flex gap-2">Description</h3>
            </div>
            <p class="text-gray-600 mt-2">{{ remede.description }}</p>
            {% endif %}
            <!-- APlante ciblée -->
            <div class="flex gap-2 items-center text-lg font-bold text-green-700 mt-5">
                <i class="fa-solid fa-leaf"></i> 
                <h3 class=" flex gap-2">Plante ciblée</h3>
            </div>
            <p class="text-gray-600 mt-2">{{ remede.target_plant.name }}</p>

            <!-- Activités recherchées -->
            <div class="flex gap-2 items-center text-lg font-bold text-green-700 mt-5">
                <i class="fa-solid fa-flask"></i> 
                <h3 class=" flex gap-2">Activités recherchées</h3>
            </div>
            <ul class="list-disc list-inside text-gray-600 mt-2">
                {% for activity in remede.activities.all %}
                <li>{{ activity.name }}</li>
                {% endfor %}    
            </ul>
        </div>

        <!-- Bouton modifier les infos -->
        <div class="flex justify-start mt-5">
            <a href="{% url 'edit_remede' remede.id %}" class="bg-green-700 hover:bg-green-800 text-white px-6 py-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                <i class="fa-solid fa-pen-to-square"></i>
                Modifier les infos
            </a>
        </div>
    </div>
</section>

<!-- Form Section -->
<section class="w-full px-4 py-12">
    <div class="max-w-7xl mx-auto">
        <!-- Options de tri -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-green-700 flex items-center gap-2 mb-6">
                <i class="fa-solid fa-sort"></i>
                Options de tri
            </h2>
            <form id="sortForm" method="GET" class="space-y-4" onsubmit="updateHiddenSortFields()">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Tri 1 -->
                    <div class="flex flex-col space-y-2">
                        <label class="text-sm font-medium text-gray-700">Premier tri</label>
                        <select name="sort0" class="form-select rounded-md border-gray-300">
                            <option value="name" {% if sort_params.0.0 == 'name' %}selected{% endif %}>Nom de la plante</option>
                            <option value="common_metabolites" {% if sort_params.0.0 == 'common_metabolites' %}selected{% endif %}>Nombre de métabolites en commun</option>
                            <option value="common_percentage" {% if sort_params.0.0 == 'common_percentage' %}selected{% endif %}>Pourcentage en commun</option>
                            <option value="meta_percentage_score" {% if sort_params.0.0 == 'meta_percentage_score' %}selected{% endif %}>Meta%</option>
                            <option value="meta_root_score" {% if sort_params.0.0 == 'meta_root_score' %}selected{% endif %}>MetaRacine</option>
                            <option value="common_activity_metabolites" {% if sort_params.0.0 == 'common_activity_metabolites' %}selected{% endif %}>Métabolites communs avec l'activité</option>
                            <option value="total_activity_metabolites" {% if sort_params.0.0 == 'total_activity_metabolites' %}selected{% endif %}>Total métabolites avec l'activité</option>
                            <option value="total_concentration" {% if sort_params.0.0 == 'total_concentration' %}selected{% endif %}>Concentration totale</option>
                        </select>
                        <select name="direction0" class="form-select rounded-md border-gray-300">
                            <option value="asc" {% if sort_params.0.1 == 'asc' %}selected{% endif %}>Croissant</option>
                            <option value="desc" {% if sort_params.0.1 == 'desc' %}selected{% endif %}>Décroissant</option>
                        </select>
                    </div>

                    <!-- Tri 2 -->
                    <div class="flex flex-col space-y-2">
                        <label class="text-sm font-medium text-gray-700">Deuxième tri</label>
                        <select name="sort1" class="form-select rounded-md border-gray-300">
                            <option value="">Aucun</option>
                            <option value="name" {% if sort_params.1.0 == 'name' %}selected{% endif %}>Nom de la plante</option>
                            <option value="common_metabolites" {% if sort_params.1.0 == 'common_metabolites' %}selected{% endif %}>Nombre de métabolites en commun</option>
                            <option value="common_percentage" {% if sort_params.1.0 == 'common_percentage' %}selected{% endif %}>Pourcentage en commun</option>
                            <option value="meta_percentage_score" {% if sort_params.1.0 == 'meta_percentage_score' %}selected{% endif %}>Meta%</option>
                            <option value="meta_root_score" {% if sort_params.1.0 == 'meta_root_score' %}selected{% endif %}>MetaRacine</option>
                            <option value="common_activity_metabolites" {% if sort_params.1.0 == 'common_activity_metabolites' %}selected{% endif %}>Métabolites communs avec l'activité</option>
                            <option value="total_activity_metabolites" {% if sort_params.1.0 == 'total_activity_metabolites' %}selected{% endif %}>Total métabolites avec l'activité</option>
                            <option value="total_concentration" {% if sort_params.1.0 == 'total_concentration' %}selected{% endif %}>Concentration totale</option>
                        </select>
                        <select name="direction1" class="form-select rounded-md border-gray-300">
                            <option value="asc" {% if sort_params.1.1 == 'asc' %}selected{% endif %}>Croissant</option>
                            <option value="desc" {% if sort_params.1.1 == 'desc' %}selected{% endif %}>Décroissant</option>
                        </select>
                    </div>

                    <!-- Tri 3 -->
                    <div class="flex flex-col space-y-2">
                        <label class="text-sm font-medium text-gray-700">Troisième tri</label>
                        <select name="sort2" class="form-select rounded-md border-gray-300">
                            <option value="">Aucun</option>
                            <option value="name" {% if sort_params.2.0 == 'name' %}selected{% endif %}>Nom de la plante</option>
                            <option value="common_metabolites" {% if sort_params.2.0 == 'common_metabolites' %}selected{% endif %}>Nombre de métabolites en commun</option>
                            <option value="common_percentage" {% if sort_params.2.0 == 'common_percentage' %}selected{% endif %}>Pourcentage en commun</option>
                            <option value="meta_percentage_score" {% if sort_params.2.0 == 'meta_percentage_score' %}selected{% endif %}>Meta%</option>
                            <option value="meta_root_score" {% if sort_params.2.0 == 'meta_root_score' %}selected{% endif %}>MetaRacine</option>
                            <option value="common_activity_metabolites" {% if sort_params.2.0 == 'common_activity_metabolites' %}selected{% endif %}>Métabolites communs avec l'activité</option>
                            <option value="total_activity_metabolites" {% if sort_params.2.0 == 'total_activity_metabolites' %}selected{% endif %}>Total métabolites avec l'activité</option>
                            <option value="total_concentration" {% if sort_params.2.0 == 'total_concentration' %}selected{% endif %}>Concentration totale</option>
                        </select>
                        <select name="direction2" class="form-select rounded-md border-gray-300">
                            <option value="asc" {% if sort_params.2.1 == 'asc' %}selected{% endif %}>Croissant</option>
                            <option value="desc" {% if sort_params.2.1 == 'desc' %}selected{% endif %}>Décroissant</option>
                        </select>
                    </div>

                    <!-- Tri 4 -->
                    <div class="flex flex-col space-y-2">
                        <label class="text-sm font-medium text-gray-700">Quatrième tri</label>
                        <select name="sort3" class="form-select rounded-md border-gray-300">
                            <option value="">Aucun</option>
                            <option value="name" {% if sort_params.3.0 == 'name' %}selected{% endif %}>Nom de la plante</option>
                            <option value="common_metabolites" {% if sort_params.3.0 == 'common_metabolites' %}selected{% endif %}>Nombre de métabolites en commun</option>
                            <option value="common_percentage" {% if sort_params.3.0 == 'common_percentage' %}selected{% endif %}>Pourcentage en commun</option>
                            <option value="meta_percentage_score" {% if sort_params.3.0 == 'meta_percentage_score' %}selected{% endif %}>Meta%</option>
                            <option value="meta_root_score" {% if sort_params.3.0 == 'meta_root_score' %}selected{% endif %}>MetaRacine</option>
                            <option value="common_activity_metabolites" {% if sort_params.3.0 == 'common_activity_metabolites' %}selected{% endif %}>Métabolites communs avec l'activité</option>
                            <option value="total_activity_metabolites" {% if sort_params.3.0 == 'total_activity_metabolites' %}selected{% endif %}>Total métabolites avec l'activité</option>
                            <option value="total_concentration" {% if sort_params.3.0 == 'total_concentration' %}selected{% endif %}>Concentration totale</option>
                        </select>
                        <select name="direction3" class="form-select rounded-md border-gray-300">
                            <option value="asc" {% if sort_params.3.1 == 'asc' %}selected{% endif %}>Croissant</option>
                            <option value="desc" {% if sort_params.3.1 == 'desc' %}selected{% endif %}>Décroissant</option>
                        </select>
                    </div>
                </div>

                <!-- Option pour exclure les métabolites ubiquitaires -->
                <div class="flex items-center gap-3 mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <input type="checkbox" id="exclude_ubiquitous_sort" name="exclude_ubiquitous" value="true" {% if exclude_ubiquitous %}checked{% endif %} class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                    <label for="exclude_ubiquitous_sort" class="text-sm font-medium text-gray-700">Exclure les métabolites ubiquitaires</label>
                    <span class="text-xs text-gray-500">Cette option permet d'exclure les métabolites présents dans de nombreuses plantes pour se concentrer sur les métabolites plus spécifiques.</span>
                </div>

                <!-- Sélection des métabolites -->
                <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Sélection des métabolites</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Métabolite 1 -->
                        <div>
                            <label for="metabolite1" class="block text-sm font-medium text-gray-700 mb-2">Métabolite 1</label>
                            <div class="relative">
                                <input type="text" 
                                       id="search1" 
                                       class="form-input w-full rounded-md border-gray-300 mb-2" 
                                       placeholder="Rechercher un métabolite...">
                                <select id="metabolite1" name="metabolite1" class="form-select w-full rounded-md border-gray-300">
                                    <option value="">Sélectionnez un métabolite...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Métabolite 2 -->
                        <div>
                            <label for="metabolite2" class="block text-sm font-medium text-gray-700 mb-2">Métabolite 2</label>
                            <div class="relative">
                                <input type="text" 
                                       id="search2" 
                                       class="form-input w-full rounded-md border-gray-300 mb-2" 
                                       placeholder="Rechercher un métabolite...">
                                <select id="metabolite2" name="metabolite2" class="form-select w-full rounded-md border-gray-300">
                                    <option value="">Sélectionnez un métabolite...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Métabolite 3 -->
                        <div>
                            <label for="metabolite3" class="block text-sm font-medium text-gray-700 mb-2">Métabolite 3</label>
                            <div class="relative">
                                <input type="text" 
                                       id="search3" 
                                       class="form-input w-full rounded-md border-gray-300 mb-2" 
                                       placeholder="Rechercher un métabolite...">
                                <select id="metabolite3" name="metabolite3" class="form-select w-full rounded-md border-gray-300">
                                    <option value="">Sélectionnez un métabolite...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="submit" class="bg-green-700 hover:bg-green-800 text-white px-6 py-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                        <i class="fa-solid fa-sort"></i>
                        Appliquer le tri
                    </button>
                </div>
            </form>
        </div>

        <form method="POST" class="space-y-12" id="plants-form">
            {% csrf_token %}
            
            <!-- Option pour exclure les métabolites ubiquitaires -->
            <div class="bg-white shadow-md rounded-lg p-6 mb-8 hidden">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="exclude_ubiquitous" name="exclude_ubiquitous" value="true" {% if exclude_ubiquitous %}checked{% endif %} class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                    <label for="exclude_ubiquitous" class="text-sm font-medium text-gray-700">Exclure les métabolites ubiquitaires</label>
                </div>
                <p class="text-xs text-gray-500 mt-2 ml-6">Cette option permet d'exclure les métabolites présents dans de nombreuses plantes pour se concentrer sur les métabolites plus spécifiques.</p>
            </div>
            
            <!-- Champs cachés pour les paramètres de tri -->
            {% for param, value in sort_params %}
                <input type="hidden" name="sort{{ forloop.counter0 }}" value="{{ param }}">
                <input type="hidden" name="direction{{ forloop.counter0 }}" value="{{ value }}">
            {% endfor %}
            
            <!-- Champs cachés pour les métabolites -->
            {% for i in "123" %}
                <input type="hidden" name="metabolite{{ i }}" id="hidden_metabolite{{ i }}">
            {% endfor %}
            
            {% for activity, plants in plants_by_activity.items %}
            <div class="activity-section">
                <div class="flex items-center gap-3 mb-6">
                    <h2 class="text-2xl font-bold text-green-700">
                        <i class="fa-solid fa-flask"></i>
                        Plantes pour l'activité : {{ activity }}
                    </h2>
                </div>
                
                <!-- Légende des couleurs -->
                <div class="legend-container mb-4">
                    <div class="legend-title">Légende des pourcentages :</div>
                    <div class="legend-item">
                        <div class="legend-color pill-blue"></div>
                        <span>Bleu : % des métabolites communs par rapport au total des métabolites de la plante (quand la plante a moins de métabolites que la plante cible)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color pill-green"></div>
                        <span>Vert : % des métabolites communs par rapport au total des métabolites de la plante (quand la plante a plus de métabolites que la plante cible)</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="plant-table">
                        <thead>
                            <tr class="">
                                <th class="w-16">Sélection</th>
                                <th>Nom de la plante</th>
                                <th>Nb métabolites (activité)</th>
                                <th>Concentration totale</th>
                                <th>Nb métabolites communs</th>
                                <th>% en commun</th>
                                <th>Meta%</th>
                                <th>MetaRacine</th>
                                <th>Nb métabolites communs (activité)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for plant in plants %}
                            <tr class="plant-row">
                                <td class="text-center">
                                    <input type="checkbox" 
                                           name="selected_plants" 
                                           value="{{ plant.id }}" 
                                           id="plant_{{ plant.id }}"
                                           {% if plant.id in selected_plants_ids %}checked{% endif %}
                                           class="plant-checkbox">
                                </td>
                                <td>
                                    <label for="plant_{{ plant.id }}" class="font-medium text-green-700 hover:text-green-800 cursor-pointer">
                                        {{ plant.name }}
                                        {% if plant.french_name %}
                                        <span class="text-xs text-gray-500">
                                            {{ plant.french_name }}
                                        </span>
                                        {% endif %}
                                    </label>
                                </td>
                                <td>
                                    <span class="concentration-badge concentration-medium">
                                        {{ plant.activity_metabolites_count|default:"0" }} 
                                    </span>
                                </td>
                                <td>
                                    {% if plant.total_concentration %}
                                        <span class="concentration-badge concentration-high">
                                            {{ plant.total_concentration|floatformat:2 }}
                                        </span>
                                    {% else %}
                                        <span class="concentration-badge concentration-low">
                                            Non spécifiée
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="concentration-badge concentration-medium">
                                        {{ plant.common_metabolites_count|default:"0" }} 
                                    </span>
                                </td>
                                <td>
                                    <span class="concentration-badge {% if plant.percentage_type == 'blue' %}pill-blue{% else %}pill-green{% endif %}">
                                        {{ plant.common_percentage|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>
                                    <span class="concentration-badge concentration-medium pill-purple">
                                        {{ plant.meta_percentage_score|floatformat:2 }}
                                    </span>
                                </td>
                                <td>
                                    <span class="concentration-badge concentration-medium pill-pink">
                                        {{ plant.meta_root_score|floatformat:2 }}
                                    </span>
                                </td>
                                <td>
                                    <span class="concentration-badge concentration-medium">
                                        {{ plant.common_activity_metabolites_count|default:"0" }} 
                                    </span>
                                </td>
                                <td class="tooltip-cell">
                                    <div class="metabolites-tooltip">
                                        <div class="metabolites-section">
                                            <h4>
                                                <i class="fa-solid fa-link"></i>
                                                Métabolites en commun avec l'activité et la plante recherchée
                                            </h4>
                                            <div class="metabolites-list">
                                                {% if plant.common_metabolites_names %}
                                                    {% with unique_metabolites=plant.common_metabolites_names|unique %}
                                                    {% for metabolite in unique_metabolites %}
                                                        <div class="metabolite-item">{{ metabolite }}</div>
                                                    {% endfor %}
                                                    {% endwith %}
                                                {% else %}
                                                    <div class="metabolite-item text-gray-500 italic">Aucun métabolite en commun</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="metabolites-section">
                                            <h4>
                                                <i class="fa-solid fa-plus"></i>
                                                Métabolites complémentaires avec l'activité
                                            </h4>
                                            <div class="metabolites-list">
                                                {% if plant.complementary_metabolites_names %}
                                                    {% with unique_complementary=plant.complementary_metabolites_names|unique %}
                                                    {% for metabolite in unique_complementary %}
                                                        <div class="metabolite-item">{{ metabolite }}</div>
                                                    {% endfor %}
                                                    {% endwith %}
                                                {% else %}
                                                    <div class="metabolite-item text-gray-500 italic">Aucun métabolite complémentaire</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}

            <!-- Récapitulatif des plantes sélectionnées -->
            <div id="recap-section" class="bg-white shadow-md rounded-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-green-700 flex items-center gap-2 mb-6">
                    <i class="fa-solid fa-list-check"></i>
                    Récapitulatif des plantes sélectionnées
                </h2>
                <div id="selected-plants-recap" class="space-y-6">
                    <!-- Rempli dynamiquement par JavaScript -->
                </div>
            </div>

            <div class="flex justify-center mt-8">
                <button type="submit" 
                        class="bg-green-700 hover:bg-green-800 text-white px-6 py-3 rounded-lg 
                               shadow-md hover:shadow-lg transition-all duration-300 
                               flex items-center gap-2">
                    <i class="fa-solid fa-check"></i>
                    Finaliser le remède
                </button>
            </div>
        </form>
    </div>
</section>
{% endblock %} 